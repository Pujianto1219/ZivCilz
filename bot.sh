#!/bin/bash
# Zivpn Central Bot Manager (Full Features)
# Repo: https://github.com/Pujianto1219/ZivCilz

BOT_FILE="/etc/zivpn/bot_data"
DOMAIN=$(cat /etc/zivpn/domain 2>/dev/null || echo "VPS-Unknown")
DATE=$(date +"%Y-%m-%d %H:%M")

# Fungsi Kirim Pesan
send_msg() {
    if [ -f "$BOT_FILE" ]; then
        DATA=$(cat $BOT_FILE)
        TOKEN=$(echo $DATA | cut -d: -f1)
        ID=$(echo $DATA | cut -d: -f2)
        MSG="$1"
        curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d chat_id="$ID" \
            -d text="$MSG" \
            -d parse_mode="Markdown" > /dev/null
    fi
}

# Fungsi Kirim File (Untuk Backup)
send_doc() {
    if [ -f "$BOT_FILE" ]; then
        DATA=$(cat $BOT_FILE)
        TOKEN=$(echo $DATA | cut -d: -f1)
        ID=$(echo $DATA | cut -d: -f2)
        FILE="$1"
        CAPTION="$2"
        curl -s -F chat_id="$ID" \
             -F document=@"$FILE" \
             -F caption="$CAPTION" \
             -F parse_mode="Markdown" \
             "https://api.telegram.org/bot$TOKEN/sendDocument" > /dev/null
    fi
}

# === LOGIKA UTAMA ===
case $1 in
    setup)
        # Menu Setup Interaktif
        clear
        echo "=== TELEGRAM BOT SETUP ==="
        echo "Panduan: Buat bot di @BotFather -> Dapat Token"
        echo "         Chat ke bot -> Cek ID di @userinfobot -> Dapat ID"
        echo ""
        read -p "Masukkan Bot Token : " token
        read -p "Masukkan Chat ID   : " chatid
        if [[ -n "$token" && -n "$chatid" ]]; then
            echo "${token}:${chatid}" > $BOT_FILE
            echo "Data tersimpan!"
            # Test langsung
            bash "$0" test
        else
            echo "Data tidak valid/kosong."
        fi
        ;;
        
    test)
        send_msg "âœ… *ZIVPN BOT TEST*%0A%0AHalo, Bot berhasil terhubung ke VPS: \`$DOMAIN\`%0A%0A_Notification System Ready_"
        echo "Pesan test dikirim ke Telegram."
        ;;
        
    create)
        # Usage: zivbot create <user> <exp_date>
        USER=$2
        EXP=$3
        MSG="âœ¨ *CREATED USER ZIVPN*%0A%0AğŸ‘¤ User: \`$USER\`%0AğŸ“… Expired: \`$EXP\`%0AğŸ–¥ï¸ Domain: \`$DOMAIN\`%0A%0A_Generated by ZivCilz_"
        send_msg "$MSG"
        ;;
        
    delete)
        # Usage: zivbot delete <user>
        USER=$2
        MSG="ğŸ—‘ï¸ *DELETED USER ZIVPN*%0A%0AğŸ‘¤ User: \`$USER\`%0AâŒ Status: Deleted by Admin%0A%0A_System Notification_"
        send_msg "$MSG"
        ;;
        
    renew)
        # Usage: zivbot renew <user> <new_exp>
        USER=$2
        EXP=$3
        MSG="ğŸ”„ *RENEW USER ZIVPN*%0A%0AğŸ‘¤ User: \`$USER\`%0AğŸ“… New Expired: \`$EXP\`%0A%0A_System Notification_"
        send_msg "$MSG"
        ;;
        
    expired)
        # Usage: zivbot expired <user>
        USER=$2
        MSG="âš ï¸ *USER EXPIRED*%0A%0AğŸ‘¤ User: \`$USER\`%0AâŒ Status: Deleted by Auto-XP%0A%0A_System Notification_"
        send_msg "$MSG"
        ;;
        
    backup)
        # Usage: zivbot backup <filepath>
        FILE=$2
        CAPTION="ğŸ“¦ *BACKUP DATA VPS*%0A%0AğŸ–¥ï¸ Domain: \`$DOMAIN\`%0AğŸ“… Tanggal: \`$DATE\`%0A%0A_Auto Backup System_"
        send_doc "$FILE" "$CAPTION"
        ;;

    *)
        # Default behavior if just 'zivbot' is typed
        bash "$0" setup
        ;;
esac
